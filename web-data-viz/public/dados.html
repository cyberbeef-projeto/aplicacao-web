<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Usuários</title>
  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="css/paginasCRUD.css">
  <link rel="icon" href="assets/icon/chip.png">
  <script src="./js/sessao.js"></script>
</head>

<body onload="validarSessao()">
  <header class="">
    <button id="but_atualizar_bl" class="clicavel bxr bxs-menu-select clicado"
      onclick="atualizarBarraLateral()"></button>
    <p id="titulo_pagina"></p>
    <nav id="buts_superiores">
      <button style="border: none;" class="clicavel clicado" onclick="baixarCSV()">Exportar dados <i
          class='bxr  bx-arrow-down-stroke-circle'></i></button>
      <button class="btn primary clicado" id="btnNew">+ Novo Registro</button>
    </nav>
  </header>

  <div class="barra_lateral sombreado ativa">
    <div id="logo"></div>
    <hr>
    <div id="usuario">
      <i class='bxr  bxs-user' style='color:#fffafa'></i>
      <a id="b_usuario" class="texto_perfil"
        style=" max-width: 100%; overflow: hidden; text-overflow: ellipsis;">User</a>
    </div>
    <hr>
    <div id="home" class="ops_home">
      <ul></ul>
      <li class="clicado"><a href="index.html">Home</a></li>
      <li class="clicado"><a href="dashboard.html">Painéis</a></li>
      <li class="clicado"><a href="dados.html?tipoDados=maquina&titulo=Máquinas">Máquinas</a></li>
      <li class="clicado"><a href="alertas.html">Alertas</a></li>
      <li class="clicado"><a href="dados.html?tipoDados=setor&titulo=Setores">Setores</a></li>
      <li class="clicado"><a href="dados.html?tipoDados=user&titulo=Usuários">Usuários</a></li>
      <li class="clicado"><a href="dados.html?tipoDados=user&titulo=Usuários">Suporte</a></li>
      <span onclick="limparSessao()"
        style="display: inline-flex; align-items: center; color: #fffafa; font-size: large; gap: 1%;"
        class="clicavel clicado" title="Clique para sair de sua conta">
        <i class='bxr  bx-arrow-out-left-square-half' style="color: #fffafa;"></i>
        <p>SAIR
        <p>
      </span>
    </div>
  </div>


  <div id="app" class="bl_ativa">
    <main class="list-panel">
      <div style="display: none;" id="metricas">
        <h3 style="display: block; align-self: flex-start;">Métricas Alertas</h3>
        <span>
          <h3>CPU</h3>
          <p>Alerta Critico: &gt; 90%</p>
          <p>Alerta Anormal: 85% ≥ x ≤ 90%</p>
          <p>Normal: &lt; 85%</p>
        </span>
        <span>
          <h3>RAM</h3>
          <p>Alerta Critico: &gt; 90%</p>
          <p>Alerta Anormal: 85% ≥ x ≤ 90%</p>
          <p>Normal: &lt; 85%</p>
        </span>
        <span>
          <h3>Disco</h3>
          <p>Alerta Critico: &gt; 90%</p>
          <p>Alerta Anormal: 85% ≥ x ≤ 90%</p>
          <p>Normal: &lt; 85%</p>
        </span>
        <span>
          <h3>Perda de Pacotes</h3>
          <p>Alerta Critico: &gt; 10%</p>
          <p>Alerta Anormal: 2,5% ≥ x ≤ 10%</p>
          <p>Normal: &lt; 2,5%</p>
        </span>
      </div>
      <h3 style="align-self: flex-start; margin-bottom: 1%;">Registros</h3>
      <table aria-label="lista de registros">
        <thead>
          <tr id="tableHead"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div id="emptyState" class="empty">Nenhum registro.</div>
    </main>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <span style="display: flex; align-items: center; flex-wrap: nowrap; gap: 1%;">
        <h3 id="modalTitle">Novo Registro</h3>
        <i id="mais_sobre" style="display: none;" class='bxr bx-help-circle info' data-title="Sobre Níveis de Permissão:
          2 - Básico  = Visualizar somente os Painéis;
          1 - Alto = Visualizar e editar todos os dados.">
        </i>
        <!-- 2 - Médio = Visualizar a todos os dados; -->
      </span>
      <div class="modal-body" id="modalBody"></div>
      <div style="display:flex;gap:1%;justify-content:flex-end;margin-top:1.5%">
        <button class="btn ghost clicado" id="modalCancel">Cancelar</button>
        <button class="btn primary clicado" id="modalSave">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const tipoDados = params.get('tipoDados');
    const tituloPagina = params.get('titulo');

    if (tipoDados == 'user') document.getElementById('mais_sobre').style.display = 'block';
    if (tipoDados == 'maquina') {
      document.getElementById('btnNew').style.display = 'none';
      // document.getElementById('titulo_pagina').style.marginRight = '50%';
      // document.getElementById('metricas').style.display = 'flex';
    }

    const campos = {
      user: [
        { key: 'nome', label: 'Nome', type: 'text' },
        { key: 'email', label: 'E-mail', type: 'email' },
        { key: 'permissaoUsuario', label: 'Nível de Permissão', type: 'select', options: ['2 - Básico', '1 - Alto'] },
        { key: 'senha', label: 'Senha', type: 'password' }
      ],
      maquina: [
        { key: 'nome', label: 'Nome', type: 'text' },
        { key: 'ultimaCap', label: 'Última Captura', type: 'text', readOnly: true }
      ],
      setor: [
        { key: 'nome', label: 'Nome', type: 'text' },
        { key: 'descricao', label: 'Descrição', type: 'textarea' }
      ],
      alerta: [
        { key: 'data', label: 'Data', type: 'text', readOnly: true },
        { key: 'maquina', label: 'Máquina', type: 'text' },
        { key: 'componente', label: 'Componente', type: 'text' },
        { key: 'tipo', label: 'Tipo', type: 'text' },
        { key: 'dado', label: 'Dado', type: 'text' },
      ]
    };

    document.getElementById('titulo_pagina').textContent = tituloPagina;
    document.querySelector('title').textContent = tituloPagina

    const barraLateral = document.querySelector('.barra_lateral');
    const butAtualizarBl = document.getElementById('but_atualizar_bl');
    const elementos = document.getElementById('app');
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    let identificador = '';

    function atualizarBarraLateral() {
      barraLateral.classList.toggle('ativa');
      elementos.classList.toggle('bl_ativa');
      butAtualizarBl.classList.toggle('bxs-menu-wide');
      butAtualizarBl.classList.toggle('bxs-menu-select');
    }

    function jsonToCSV(jsonArray) {
      if (!jsonArray.length) return "";

      const headers = Object.keys(jsonArray[0]);

      const linhas = jsonArray.map(obj =>
        headers.map(h =>
          JSON.stringify(obj[h] ?? "")
        ).join(";")
      );

      return [headers.join(";"), ...linhas].join("\n");
    }

    function baixarCSV() {
      const csv = jsonToCSV(dados[tipoDados]);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "dados.csv";
      link.click();

      URL.revokeObjectURL(url);
    }

    function renderTable() {
      tableHead.innerHTML = '';
      campos[tipoDados].forEach(f => { const th = document.createElement('th'); th.textContent = f.label; tableHead.appendChild(th); });
      if (tipoDados != 'alerta') {
        const thAct = document.createElement('th'); thAct.textContent = 'Ações'; tableHead.appendChild(thAct);
      }
      tableBody.innerHTML = '';
      if (store.length === 0) { document.getElementById('emptyState').style.display = 'block'; return; }
      document.getElementById('emptyState').style.display = 'none';
      store.forEach((row, i) => {
        const tr = document.createElement('tr');
        campos[tipoDados].forEach(f => { const td = document.createElement('td'); td.textContent = row[f.key] || '-'; tr.appendChild(td); });
        if (tipoDados != 'alerta') {
          const tdAct = document.createElement('td');
          const btnE = document.createElement('button'); btnE.className = 'btn clicado'; btnE.textContent = 'Editar';
          btnE.onclick = () => openModal('Editar Registro', i);
          const btnD = document.createElement('button'); btnD.className = 'btn danger clicado'; btnD.textContent = 'Excluir';
          btnD.onclick = () => {
            if (tipoDados == 'setor') realizarCRUD("/crud/deletarSetor", store[i]);
            if (tipoDados == 'user') realizarCRUD("/crud/deletarUsuario", store[i]);
            if (tipoDados == 'maquina') realizarCRUD("/crud/deletarMaquina", store[i]);
            store.splice(i, 1);
            renderTable();
          };
          tdAct.append(btnE, btnD); tr.appendChild(tdAct);
        }
        tableBody.appendChild(tr);
      });
    }

    function realizarCRUD(router, registro) {
      fetch(router, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: sessionStorage.TOKEN_EMPRESA,
          ...registro,
          id2: identificador,
        })
      }).then(function (resposta) {
        if (resposta.ok) {
          console.log(resposta);
          resposta.json().then(json => {
            console.log(json);
          });

        } else {
          console.log("Houve um erro ao tentar criar o usuário");
          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })
    }

    function novoRegistro() {
      const inputs = modalBody.querySelectorAll('[data-key]');
      const obj = {};
      inputs.forEach(i => obj[i.dataset.key] = i.value);
      if (obj['permissaoUsuario']) obj['permissaoUsuario'] = parseInt(obj['permissaoUsuario'][0]);
      if (tipoDados == "user") realizarCRUD("/crud/criarUsuario", obj);
      if (tipoDados == "setor") realizarCRUD("/crud/criarSetor", obj);
      if (obj['senha']) obj['senha'] = '*********';
      if (editingIndex >= 0) store[editingIndex] = obj; else store.push(obj);
      modalBackdrop.style.display = 'none'; renderTable();
    }

    function editarRegistro() {
      const inputs = modalBody.querySelectorAll('[data-key]');
      const obj = {};
      inputs.forEach(i => obj[i.dataset.key] = i.value);
      if (obj['permissaoUsuario']) obj['permissaoUsuario'] = parseInt(obj['permissaoUsuario'][0]);
      if (tipoDados == "user") realizarCRUD("/crud/editarUsuario", obj);
      if (tipoDados == "maquina") realizarCRUD("/crud/editarMaquina", obj);
      if (tipoDados == "setor") realizarCRUD("/crud/editarSetor", obj);
      if (obj['senha']) obj['senha'] = '*********';
      if (editingIndex >= 0) store[editingIndex] = obj; else store.push(obj);
      modalBackdrop.style.display = 'none'; renderTable();
    }

    function openModal(title, index = -1) {
      if (title == "Novo Registro") document.getElementById('modalSave').addEventListener("click", novoRegistro);
      else if (title == "Editar Registro") document.getElementById('modalSave').addEventListener("click", editarRegistro);
      editingIndex = index;
      modalTitle.textContent = title;
      modalBody.innerHTML = '';
      campos[tipoDados].forEach(f => {
        const wrap = document.createElement('div'); wrap.className = 'campo-card';
        const lbl = document.createElement('label'); lbl.textContent = f.label; wrap.appendChild(lbl);
        let input;
        if (f.type === 'textarea') input = document.createElement('textarea');
        else if (f.type === 'select') { input = document.createElement('select'); (f.options || []).forEach(o => { const op = document.createElement('option'); op.value = op.textContent = o; input.appendChild(op) }); }
        else input = document.createElement('input'), input.type = f.type || 'text';
        input.dataset.key = f.key;
        if (f.readOnly) input.readOnly = true;
        input.value = index >= 0 ? store[index][f.key] || '' : '';
        wrap.appendChild(input);
        modalBody.appendChild(wrap);
      });
      identificador = modalBody.querySelectorAll('input')[0].value;
      modalBackdrop.style.display = 'flex';
    }

    document.getElementById('btnNew').onclick = () => openModal('Novo Registro');
    document.getElementById('modalCancel').onclick = () => modalBackdrop.style.display = 'none';

    dados = {
      user: [],
      maquina: [
        { nome: 'Máquina 1', ultimaCap: '16/10/2025' },
        { nome: 'Máquina 2', ultimaCap: '16/10/2025' },
        { nome: 'Máquina 3', ultimaCap: '16/10/2025' }
      ],
      setor: [
        { nome: 'Setor 1', numMaq: '3' },
        { nome: 'Setor 2', numMaq: '1' }
      ],
      alerta: [
        { data: '13/10/2025 13:00', maquina: 'Máquina 1', componente: 'Disco', tipo: 'Anormal', dado: '90%' },
        { data: '14/10/2025 14:43', maquina: 'Máquina 1', componente: 'Disco', tipo: 'Crítico', dado: '91%' },
        { data: '14/10/2025 16:44', maquina: 'Máquina 1', componente: 'Disco', tipo: 'Crítico', dado: '91%' },
        { data: '14/10/2025 16:00', maquina: 'Máquina 2', componente: 'CPU', tipo: 'Crítico', dado: '99%' },
        { data: '15/10/2025 16:00', maquina: 'Máquina 3', componente: 'CPU', tipo: 'Crítico', dado: '99%' }
      ]
    }


    let store = [];

    if (tipoDados == "user") {
      fetch("/crud/usuarios", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: sessionStorage.TOKEN_EMPRESA })
      }).then(function (resposta) {
        if (resposta.ok) {
          console.log(resposta);
          resposta.json().then(json => {
            dados['user'] = json;
            store = dados[tipoDados]
            renderTable();
          });

        } else {
          console.log("Houve um erro ao tentar exibir os usuários");
          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })
    }
    else if (tipoDados == "maquina") {
      fetch("/crud/maquinas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: sessionStorage.TOKEN_EMPRESA })
      }).then(function (resposta) {
        if (resposta.ok) {
          console.log(resposta);
          resposta.json().then(json => {
            dados['maquina'] = json;
            store = dados[tipoDados]
            renderTable();
          });

        } else {
          console.log("Houve um erro ao tentar exibir os usuários");
          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })
    }
    else if (tipoDados == "setor") {
      fetch("/crud/setores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: sessionStorage.TOKEN_EMPRESA })
      }).then(function (resposta) {
        if (resposta.ok) {
          console.log(resposta);
          resposta.json().then(json => {
            dados['setor'] = json;
            store = dados[tipoDados]
            renderTable();
          });

        } else {
          console.log("Houve um erro ao tentar exibir os usuários");
          resposta.text().then(texto => {
            console.error(texto);
          });
        }

      }).catch(function (erro) {
        console.log(erro);
      })
    }
    else {
      store = dados[tipoDados]
      renderTable();
    }

  </script>
</body>

</html>