<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="css/alertas.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="assets/icon/chip.png">
    <script src="./js/sessao.js"></script>
    <!-- <script src="./js/dadosMock.js"></script> -->
    <title>Dados - CyberBeef</title>
</head>

<body onload="validarSessao()">
    <header class="navbar">
        <button id="but_atualizar_bl" class="clicavel bxr bxs-menu-select clicado"
            onclick="atualizarBarraLateral()"></button>
        <p style="margin-right: 50%;">Alertas</p>
        <a style="display: none;" class="clicavel clicado">Gerar Relatório</a>
    </header>

    <div class="barra_lateral sombreado ativa">
        <div id="logo"></div>
        <hr>
        <div id="usuario">
            <i class='bxr  bxs-user' style='color:#fffafa'></i>
            <a id="b_usuario" class="texto_perfil"
                style=" max-width: 100%; overflow: hidden; text-overflow: ellipsis;">User</a>
        </div>
        <hr>
        <div id="home" class="ops_home">
            <ul></ul>
            <li class="clicado"><a href="index.html">Home</a></li>
            <li class="clicado"><a href="dashboard.html">Painéis</a></li>
            <li class="clicado"><a href="dados.html?tipoDados=maquina&titulo=Máquinas">Máquinas</a></li>
            <li class="clicado"><a href="alertas.html">Alertas</a></li>
            <li class="clicado"><a href="dados.html?tipoDados=setor&titulo=Setores">Setores</a></li>
            <li class="clicado"><a href="dados.html?tipoDados=user&titulo=Usuários">Usuários</a></li>
            <li class="clicado"><a href="https://cyberbeef.atlassian.net/servicedesk/customer/portal/2">Suporte</a></li>
            <span onclick="limparSessao()"
                style="display: inline-flex; align-items: center; color: #fffafa; font-size: large; gap: 1%;"
                class="clicavel clicado" title="Clique para sair de sua conta">
                <i class='bxr  bx-arrow-out-left-square-half' style="color: #fffafa;"></i>
                <p>SAIR <a href="index.html"></a></p>
            </span>
        </div>
    </div>

    <div id="elementos" class="bl_ativa">
        <div class="cards">
            <span class="abas_kpis">
                <button data-aba="1" class="kpi interativo">
                    <span class="info-icon">
                        <i class='bx bx-info-circle'></i>
                        <span class="tooltip">
                            Filtro aplicado aos dados
                        </span>
                    </span>
                    <b id="kpi1" class="dado_card">Todas as Máquinas</b>
                </button>

                <button data-aba="2" class="kpi interativo">
                    <span class="info-icon">
                        <i class='bx bx-info-circle'></i>
                        <span class="tooltip">
                            Número de alertas (críticos ou anormais)
                        </span>
                    </span>
                    <b id="kpi2" class="dado_card">CARREGANDO...</b>
                    <p id="kpi2_desc" class="text_longo">Alerta(s)</p>
                </button>

                <button data-aba="3" class="kpi interativo">
                    <span class="info-icon">
                        <i class='bx bx-info-circle'></i>
                        <span class="tooltip">
                            Número de alertas críticos
                        </span>
                    </span>
                    <b id="kpi3" class="dado_card critico">CARREGANDO...</b>
                    <p id="kpi3_desc" class="text_longo">Alerta(s) Crítico(s)</p>
                </button>

                <button data-aba="4" class="kpi interativo">
                    <span class="info-icon">
                        <i class='bx bx-info-circle'></i>
                        <span class="tooltip">
                            Número de alertas anormais
                        </span>
                    </span>
                    <b id="kpi4" class="dado_card anormal">CARREGANDO...</b>
                    <p id="kpi4_desc" class="text_longo">Alerta(s) Anormal(is)</p>
                </button>
            </span>

            <div id="aba_conteudo" class="interativo">
                <div class="filtros">
                    <div class="periods" role="tablist" aria-label="Períodos">
                        <button data-period="" class="active">Todos</button>
                        <button data-period=" AND DATE(l.dthCaptura) = CURDATE()">Hoje</button>
                        <button data-period=" AND l.dthCaptura >= NOW() - INTERVAL 7 DAY">Últimos 7 dias</button>
                        <button data-period=" AND l.dthCaptura >= NOW() - INTERVAL 30 DAY">Últimos 30 dias</button>
                        <button data-period=" AND l.dthCaptura >= NOW() - INTERVAL 6 MONTH">Último semestre</button>
                    </div>
                    <div id="barra_pesquisa">
                        <input type="text" placeholder="Filtrar por máquinas..." id="pesquisa" class="">
                        <div id="nomes_dash" class="accordion"></div>
                    </div>
                    <a id="but_export" class="clicavel clicado" onclick="baixarCSV()">Exportar dados <i
                            class='bxr  bx-arrow-down-stroke-circle'></i></a>
                </div>
                <h3 style="display: block; align-self: flex-start; margin-left: 2.4%;">Métricas Alertas</h3>
                <main class="list-panel">
                    <div id="metricas">
                        <span>
                            <h3>CPU <i class='bxr  bx-chip'></i> </h3>
                            <p class="critico">Alerta Crítico: &gt; 90%</p>
                            <p class="anormal">Alerta Anormal: 85% ≥ x ≤ 90%</p>
                            <p class="normal">Normal: &lt; 85%</p>
                        </span>
                        <span>
                            <h3>RAM <i class='bxr  bx-microchip'></i></i></h3>
                            <p class="critico">Alerta Crítico: &gt; 90%</p>
                            <p class="anormal">Alerta Anormal: 85% ≥ x ≤ 90%</p>
                            <p class="normal">Normal: &lt; 85%</p>
                        </span>
                        <span>
                            <h3>Disco <i class='bxr  bx-hard-drive'></i></h3>
                            <p class="critico">Alerta Crítico: &gt; 90%</p>
                            <p class="anormal">Alerta Anormal: 85% ≥ x ≤ 90%</p>
                            <p class="normal">Normal: &lt; 85%</p>
                        </span>
                        <span>
                            <h3>Perda de Pacotes <i class='bxr  bx-wifi-2'></i></h3>
                            <p class="critico">Alerta Crítico: &gt; 10%</p>
                            <p class="anormal">Alerta Anormal: 2,5% ≥ x ≤ 10%</p>
                            <p class="normal">Normal: &lt; 2,5%</p>
                        </span>
                    </div>
                    <h3 style="align-self: flex-start; margin-bottom: 1%;">Registros</h3>
                    <table aria-label="lista de registros">
                        <thead>
                            <tr id="tableHead"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                    <div id="emptyState" class="empty">Nenhum Alerta.</div>
                </main>
            </div>

        </div>
        <div id="graficos">
            <span class="grafico sombreado interativo"><canvas id="grafico1"></canvas> </span>
            <span class="grafico sombreado interativo"><canvas id="grafico2"></canvas> </span>
        </div>
    </div>

</body>
<script>
    Chart.defaults.color = "rgba(255,255,255,0.8)";
    Chart.defaults.font.family = "Inter, sans-serif";
    Chart.defaults.plugins.tooltip.bodyColor = "#fff";
    Chart.defaults.font.size = 12;

    const barraLateral = document.querySelector('.barra_lateral');
    const butAtualizarBl = document.getElementById('but_atualizar_bl');

    const elementos = document.getElementById('elementos');

    const dadosCard = document.querySelectorAll('.dado_card')
    const buttons = document.querySelectorAll('.abas_kpis button');

    const tipoDados = "alerta";
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');

    const kpi1 = document.getElementById('kpi1');
    const kpi2 = document.getElementById('kpi2');
    const kpi3 = document.getElementById('kpi3');
    const kpi4 = document.getElementById('kpi4');

    const localGrafico1 = document.getElementById('grafico1');
    const localGrafico2 = document.getElementById('grafico2');
    let grafico1 = null;
    let grafico2 = null;

    const popup = document.getElementById('barra_pesquisa');
    const campo = document.getElementById('pesquisa');
    const nomesDash = document.getElementById('nomes_dash');

    campo.addEventListener('input', e => {
        const termo = e.target.value.toLowerCase();
        document.querySelectorAll('.item').forEach(item => {
            const texto = item.querySelector('.titulo_dash').textContent.toLowerCase();
            item.style.display = texto.includes(termo) ? 'block' : 'none';
        });
    });

    const butsFiltro = document.querySelectorAll('.periods button')
    let filtroData = ''
    let filtroMaquina = ''

    const campos = {
        alerta: [
            { key: 'dataHora', label: 'Data/Hora', type: 'text' },
            { key: 'maquina', label: 'Máquina', type: 'text' },
            { key: 'componente', label: 'Componente', type: 'text' },
            { key: 'tipo', label: 'Tipo', type: 'text' },
            { key: 'dado', label: 'Dado', type: 'text' },
        ]
    };

    dados = {
        alerta: []
    }

    butsFiltro.forEach(but => {
        but.addEventListener('click', () => {
            butsFiltro.forEach(b => b.classList.remove('active'));
            but.classList.add('active');
            filtroData = but.dataset['period'];
            trazerDados();
        })
    });

    function atualizarBarraLateral() {
        barraLateral.classList.toggle('ativa');
        elementos.classList.toggle('bl_ativa');
        butAtualizarBl.classList.toggle('bxs-menu-wide');
        butAtualizarBl.classList.toggle('bxs-menu-select');
    }

    function jsonToCSV(jsonArray) {
        if (!jsonArray.length) return "";

        const headers = Object.keys(jsonArray[0]);

        const linhas = jsonArray.map(obj =>
            headers.map(h =>
                JSON.stringify(obj[h] ?? "")
            ).join(";")
        );

        return [headers.join(";"), ...linhas].join("\n");
    }

    function baixarCSV() {
        const csv = jsonToCSV(dados['alerta']);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "dados.csv";
        link.click();

        URL.revokeObjectURL(url);
    }


    function renderTable() {
        tableHead.innerHTML = '';
        campos[tipoDados].forEach(f => {
            const th = document.createElement('th');
            th.textContent = f.label;
            tableHead.appendChild(th);
        });
        tableBody.innerHTML = '';
        if (store.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            return;
        }
        document.getElementById('emptyState').style.display = 'none';
        store.forEach((row, i) => {
            const tr = document.createElement('tr');
            campos[tipoDados].forEach(f => {
                const td = document.createElement('td');
                td.textContent = row[f.key] || '-';
                let num = Number(td.textContent);
                if (!isNaN(num)) {
                    td.textContent = Math.round(num, 2) + "%";
                }
                if (td.textContent == 'Anormal') td.classList.add('anormal');
                if (td.textContent == 'Critico') {
                    td.textContent = "Crítico";
                    td.classList.add('critico');
                }
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    store = dados[tipoDados]
    renderTable();

    async function trazerDados() {
        filtroCompleto = `WHERE sm.tokenEmpresa = '${sessionStorage.TOKEN_EMPRESA}'`;
        filtroCompleto = filtroCompleto + filtroData + filtroMaquina;
        nomesDash.innerHTML = '<button class="titulo_dash clicado">Todas as Máquinas</button>';

        try {
            nomesDash.innerHTML = '<button class="titulo_dash clicado">Todas as Máquinas</button>';
            (await (await fetch("/dash/maquinas", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tokenEmpresa: sessionStorage.TOKEN_EMPRESA })
            })).json()).forEach(maquina => {
                const nome = document.createElement("div");
                nome.classList.add("item", "clicado");
                nome.innerHTML = `<button class="titulo_dash">${maquina.hostname}</button>`;
                nomesDash.appendChild(nome);

                nomesDash.querySelectorAll('button').forEach(but => {
                    but.addEventListener('click', () => {
                        if (but.textContent == "Todas as Máquinas") filtroMaquina = '';
                        else filtroMaquina = ` AND m.hostname = '${but.textContent}'`
                        kpi1.textContent = but.textContent;
                        trazerDados();
                    })
                });
            });
        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }

        try {
            let kpiTodas = (await (await fetch("/alertas/kpis", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filtro: filtroCompleto })
            })).json())
            kpiTodas = kpiTodas[0];
            kpi2.textContent = kpiTodas.alertasGerais;
            kpi3.textContent = kpiTodas.alertasCriticos;
            kpi4.textContent = kpiTodas.alertasAnormais;

            if (!grafico1) {
                grafico1 = new Chart(localGrafico1, {
                    type: 'pie',
                    data: {
                        labels: ['Crítico', 'Anormal'],
                        datasets: [{
                            data: [kpiTodas.alertasCriticos, kpiTodas.alertasAnormais], backgroundColor: ['#E94F37', '#FFD447'], borderWidth: 2,
                            borderColor: '#fff', hoverOffset: 12
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true, text: 'Distribuição de Alertas', color: '#fff', font: { size: 16, weight: 'bold' }, padding: 14
                            },
                            legend: {
                                position: 'bottom', labels: { usePointStyle: true, padding: 16 }
                            }
                        }
                    }
                });
            } else {
                grafico1.data.datasets[0].data = [kpiTodas.alertasCriticos, kpiTodas.alertasAnormais];
                grafico1.update();
            }

        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }

        try {
            let dadosTabela = (await (await fetch("/alertas/tabela", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filtro: filtroCompleto })
            })).json())
            dados = { alerta: dadosTabela }
            store = dados[tipoDados];
            renderTable();

        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }

        try {
            let dadosGraficoBarras = (await (await fetch("/alertas/graficoBarras", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filtro: filtroCompleto })
            })).json())
            labels = [];
            data = [];
            for (dado of dadosGraficoBarras) {
                data.push(dado['numAlertas']);
                labels.push(dado['maquina']);
            }

            if (!grafico2) {
                grafico2 = new Chart(localGrafico2, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{ label: "N° Alerta(s)", data: data, backgroundColor: "#4B6CF0" }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { display: true, color: "rgba(255,255,255, 0.05)" },
                                ticks: { stepSize: 1, callback: function (value) { return Number.isInteger(value) ? value : null; } }
                            },
                            x: { title: { display: true, text: 'Máquina' }, }
                        },
                        plugins: {
                            title: { display: true, text: '5 Máquinas com Mais Alertas', color: '#fff', font: { size: 16, weight: 'bold' }, padding: 14 },
                            legend: { labels: { color: "#fff" } }
                        }
                    }
                });
            } else {
                grafico2.data.labels = labels;
                grafico2.data.datasets[0].data = data;
                grafico2.update();
            }


        } catch (erro) {
            console.error("Erro na requisição:", erro);
        }
    }

    //Primeira leva de dados
    trazerDados();

    //Loop dos dados
    const loopDosDados = setInterval(trazerDados, 5000);

</script>

</html>