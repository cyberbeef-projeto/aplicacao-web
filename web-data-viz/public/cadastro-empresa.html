<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="css/cadastro-empresa.css">
  <link rel="icon" href="/web-data-viz/public/assets/icon/chip.png">
  <title>Cadastro de Empresas - CyberBeef</title>
</head>

<body>
  <div class="barra_lateral sombreado ativa">

    <div id="logo">
      <img src="./assets/imgs/logo.png" alt="">
    </div>
    <hr style="border-color: #334155;">
    <div id="usuario">
      <i class='bxs-user' style='color:#fffafa'></i>
      <a id="b_usuario">Administrador</a>
    </div>
    <hr style="border-color: #334155;">

    <div id="home">
      <ul></ul>
      <li class="clicado"><a href="index.html">Controle e Acesso</a></li>
      <li class="clicado"><a href="empresa.html">Empresas</a></li>
      <li class="clicado"><a href="disponibilidade.html">Disponibilidade</a></li>
      <li class="clicado"><a href="jira-empresa.html">Chamados Jira</a></li>
      <span
        style="display: inline-flex; align-items: center; color: #fffafa; font-size: large; gap: 1%; cursor: pointer;">
        <i class='bx bx-arrow-out-left-square-half' style="color: #fffafa;"></i>
        <p>Sair <a href="index.html"></a></p>
      </span>
    </div>
  </div>
  <div class="conteudo-principal">
    <header class="navbar">
      <button id="but_atualizar_bl" class="menu-btn" onclick="atualizarBarraLateral()">
        <i class='bx bx-menu'></i>
        <span id="sel_componentes" name="op_setor" class="sel_dash"></span>
      </button>

      <h1>Cadastro de Empresas</h1>
    </header>



    <div class="container-formulario">
      <div class="tabs">
        <button class="tab" onclick="mostrarAba('formulario')">Dados Empresariais</button>
        <button class="tab ativa" onclick="mostrarAba('listagem')">Empresas Cadastradas</button>
      </div>

      <!-- Formulário -->
      <form class="formulario" id="formCadastroEmpresa" onsubmit="cadastrarEmpresa(event)">
    <div class="form-row">
        <div class="form-grupo">
            <label>Razão Social</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite a razão social" id="razaoSocial" required>
                 <i class='bx  bx-enterprise'></i> 
            </div>
        </div>
        <div class="form-grupo">
            <label>Nome Fantasia</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite o nome fantasia" id="nomeFantasia" required>
                <i class='bx  bx-enterprise'></i> 
            </div>
        </div>
        <div class="form-grupo">
            <label>CNPJ</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite o CNPJ" id="cnpj" required>
                <i class='bx bx-edit'></i>
            </div>
        </div>
    </div>

    <div class="form-row">
        <div class="form-grupo">
            <label>CEP</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite  o CEP" id="cep">
                <i class='bx bx-map'></i>
            </div>
        </div>
        <div class="form-grupo">
            <label>Logradouro</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite o logradouro" id="logradouro">
                <i class='bx bx-map'></i>
            </div>
        </div>
        <div class="form-grupo">
            <label>Bairro</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite o bairro" id="bairro">
                <i class='bx bx-map'></i>
            </div>
        </div>
    </div>

    <div class="form-row">
        <div class="form-grupo">
            <label>Cidade</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite a cidade" id="cidade">
                <i class='bx bx-map'></i>
            </div>
        </div>
        <div class="form-grupo">
            <label>UF</label>
            <div class="input-wrapper">
                <select id="estado">
                    <option value="">Selecione</option>
                    <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                    <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                    <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                    <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                    <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                    <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                    <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                    <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                    <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                </select>
                <i class='bx bx-chevron-down'></i>
            </div>
        </div>
        <div class="form-grupo">
            <label>Número</label>
            <div class="input-wrapper">
                <input type="text" placeholder="Digite o número" id="numero">
                <i class='bx bx-map'></i>
            </div>
        </div>
        <div class="form-grupo">
            <label>Token Empresa</label>
            <div class="input-wrapper">
                <input type="number" placeholder="ID único" id="tokenEmpresa" required>
                <i class='bx bx-chevron-down'></i>
            </div>
        </div>
    </div>

    <div class="form-acao">
        <button type="button" class="btn-primeiro" onclick="formCadastroEmpresa.reset()">Cancelar</button>
        <button type="submit" class="btn-segundo">Salvar</button>
    </div>
</form>


      <!-- Listagem -->
      <div class="container-listagem oculto" id="listagem">
        <div class="listagem-header">
          <div class="listagem-controles">
            <label>Mostrar</label>
            <select id="registrosPorPagina" onchange="atualizarTabela()">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
            <span style="color: #cbd5e1;">registros</span>
          </div>
          <div class="busca-wrapper">
            <input type="text" placeholder="Buscar..." id="campoBusca" oninput="filtrarEmpresas()">
          </div>
          <button class="btn-adicionar" onclick="mostrarAba('formulario')">
            <i class='bx bx-plus'></i>
            Adicionar
          </button>
        </div>

        <div class="tabela-wrapper">
          <table class="tabela-empresas">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome Fantasia</th>
      <th>CNPJ</th>
      <th>Data do Cadastro</th>
      <th style="text-align: center;">Ações</th>
      
    </tr>
  </thead>
  <tbody id="tabelaBody">
    
    <!-- Os dados serão inseridos aqui via JS -->
  </tbody>
</table>

          </table>
        </div>

        <div class="paginacao">
          <div class="paginacao-info">
            <span id="paginacaoInfo">1 a 2 de 2</span>
          </div>
          <div class="paginacao-controles">
            <button class="btn-pagina" id="btnAnterior" onclick="paginaAnterior()" disabled>&lt;</button>
            <button class="btn-pagina ativa" id="btnPagina1" onclick="irParaPagina(1)">1</button>
            <button class="btn-pagina" id="btnProxima" onclick="proximaPagina()" disabled>&gt;</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal formulário -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3 id="modalTitle">Nova Empresa</h3>
      <form id="formulario" onsubmit="salvarEmpresa(event)">
        <div class="modal-body">
          <div class="campo-card">
            <input type="hidden" id="modal_tokenEmpresa">

            <label>Razão Social *</label>
            <input type="text" id="modal_razaoSocial" placeholder="Digite a razão social" required>
          </div>
          <div class="campo-card">
            <label>Nome Fantasia *</label>
            <input type="text" id="modal_nomeFantasia" placeholder="Digite o nome fantasia" required>
          </div>
          <div class="campo-card">
            <label>CNPJ *</label>
            <input type="text" id="modal_cnpj" placeholder="00.000.000/0000-00" required>
          </div>
          <div class="campo-card">
            <label>CEP</label>
            <input type="text" id="modal_cep" placeholder="00000-000">
          </div>
          <div class="campo-card">
            <label>Logradouro</label>
            <input type="text" id="modal_logradouro" placeholder="Digite o endereço">
          </div>
          <div class="campo-card">
            <label>Bairro</label>
            <input type="text" id="modal_bairro" placeholder="Digite o bairro">
          </div>
          <div class="campo-card">
            <label>Cidade</label>
            <input type="text" id="modal_cidade" placeholder="Digite a cidade">
          </div>
          <div class="campo-card">
            <label>UF</label>
            <select id="modal_uf">
              <option value="">Selecione</option>
              <option value="AC">AC</option>
              <option value="AL">AL</option>
              <option value="AP">AP</option>
              <option value="AM">AM</option>
              <option value="BA">BA</option>
              <option value="CE">CE</option>
              <option value="DF">DF</option>
              <option value="ES">ES</option>
              <option value="GO">GO</option>
              <option value="MA">MA</option>
              <option value="MT">MT</option>
              <option value="MS">MS</option>
              <option value="MG">MG</option>
              <option value="PA">PA</option>
              <option value="PB">PB</option>
              <option value="PR">PR</option>
              <option value="PE">PE</option>
              <option value="PI">PI</option>
              <option value="RJ">RJ</option>
              <option value="RN">RN</option>
              <option value="RS">RS</option>
              <option value="RO">RO</option>
              <option value="RR">RR</option>
              <option value="SC">SC</option>
              <option value="SP">SP</option>
              <option value="SE">SE</option>
              <option value="TO">TO</option>
            </select>
          </div>
          <div class="campo-card">
            <label>Número</label>
            <input type="text" id="modal_numero" placeholder="Nº">
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-segundo clicado" onclick="fecharModal()">Cancelar</button>
          <button type="submit" class="btn-primeiro clicado">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal confirmação de  Exclusão -->
  <div class="modal-backdrop" id="modalExcluir">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color: #f87171; display: flex; align-items: center; gap: 0.5rem;">
        <i class='bx bx-error-circle' style="font-size: 1.8rem;"></i>
        Confirmar Desativação
      </h3>
      <div style="margin: 1.5rem 0;">
        <p style="color: #cbd5e1; font-size: 1rem; line-height: 1.6;">
          Tem certeza que deseja desativar a empresa <strong id="nomeEmpresaExcluir" style="color: #fff;"></strong>?
        </p>
        <p style="color: #9ca3af; font-size: 0.875rem; margin-top: 0.75rem;">
        
        </p>
      </div>
      <div class="modal-actions" style="margin-top: 1.5rem;">
        <button type="button" class="btn-segundo clicado" onclick="fecharModalExcluir()">Cancelar</button>
        <button type="button" class="btn-primeiro clicado" style="background-color: #dc2626;"
          onclick="confirmarExclusao()">Desativar</button>
      </div>
    </div>
  </div>

 <script>
let empresas = [];
let empresasFiltradas = [];

let paginaAtual = 1;
let registrosPorPagina = 10;

let excluindoIndex = -1;

/* TROCA ENTRE ABAS */
function mostrarAba(aba) {
  const formulario = document.getElementById("formCadastroEmpresa");
  const listagem = document.getElementById("listagem");
  const tabs = document.querySelectorAll(".tab");

  if (aba === "formulario") {
    formulario.classList.remove("oculto");
    listagem.classList.add("oculto");
    tabs[0].classList.add("ativa");
    tabs[1].classList.remove("ativa");
  } else {
    formulario.classList.add("oculto");
    listagem.classList.remove("oculto");
    tabs[0].classList.remove("ativa");
    tabs[1].classList.add("ativa");
  }
}

/* BUSCA */
function filtrarEmpresas() {
  const busca = document.getElementById("campoBusca").value.toLowerCase();

  empresasFiltradas = empresas.filter(emp =>
    emp.nomeFantasia.toLowerCase().includes(busca) ||
    emp.razaoSocial.toLowerCase().includes(busca) ||
    emp.cnpj.includes(busca)
  );

  paginaAtual = 1;
  renderizarTabela();
}

/* CARREGAR EMPRESAS DO BANCO*/
function carregarEmpresas() {
  fetch("/cadastroempresa/listar")
    .then(res => res.json())
    .then(dados => {
      console.log("EMPRESAS DO BANCO:", dados);

      empresas = dados;
      empresasFiltradas = [...empresas];
      renderizarTabela();
    })
    .catch(err => console.error("Erro ao carregar:", err));
}

/*RENDERIZAR TABELA*/
function renderizarTabela() {
  const tbody = document.getElementById("tabelaBody");

  const inicio = (paginaAtual - 1) * registrosPorPagina;
  const fim = inicio + registrosPorPagina;

  const pagina = empresasFiltradas.slice(inicio, fim);

  tbody.innerHTML = pagina
    .map((emp, index) => `
      <tr>
        <td>${emp.tokenEmpresa}</td>
        <td>${emp.nomeFantasia}</td>
        <td>${emp.cnpj}</td>
        <td>${formatarData(emp.dataCadastro) || "-"}</td>
        <td style="text-align: center; display:flex; gap:8px; justify-content:center;">
           <button class="btn-acao btn-editar"
          onclick="abrirModalEdicao(${inicio + index})">
    <i class='bx bx-edit'></i>
  </button>
          <button class="btn-acao btn-excluir"
                  onclick="abrirModalExcluir(${inicio + index})">
            <i class='bx bx-block'></i>
          </button>
        </td>
      </tr>
    `)
    .join("");

  atualizarPaginacao();
}

function formatarData(data) {
  if (!data) return "-";
  const d = new Date(data);
  return d.toLocaleDateString("pt-BR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric"
  });
}

/*PAGINAÇÃO */
function atualizarTabela() {
  registrosPorPagina = Number(document.getElementById("registrosPorPagina").value);
  paginaAtual = 1;
  renderizarTabela();
}

function atualizarPaginacao() {
  const total = empresasFiltradas.length;
  const inicio = (paginaAtual - 1) * registrosPorPagina + 1;
  const fim = Math.min(paginaAtual * registrosPorPagina, total);

  document.getElementById("paginacaoInfo").innerText = `${inicio} a ${fim} de ${total}`;

  const totalPaginas = Math.ceil(total / registrosPorPagina);

  document.getElementById("btnAnterior").disabled = paginaAtual === 1;
  document.getElementById("btnProxima").disabled = paginaAtual === totalPaginas || total === 0;
}

function proximaPagina() {
  const totalPaginas = Math.ceil(empresasFiltradas.length / registrosPorPagina);
  if (paginaAtual < totalPaginas) {
    paginaAtual++;
    renderizarTabela();
  }
}

function paginaAnterior() {
  if (paginaAtual > 1) {
    paginaAtual--;
    renderizarTabela();
  }
}

/* ADASTRAR EMPRESA */
function cadastrarEmpresa(event) {
  event.preventDefault();

  let dados = {
    tokenEmpresa: tokenEmpresa.value,
    razaoSocial: razaoSocial.value,
    nomeFantasia: nomeFantasia.value,
    cnpj: cnpj.value,
    logradouro: logradouro.value,
    numero: numero.value,
    bairro: bairro.value,
    cidade: cidade.value,
    estado: estado.value,
    cep: cep.value
  };

  console.log("ENVIANDO AO BACKEND:", dados);

  fetch("/cadastroempresa/cadastrar", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(dados)
  })
    .then(res => {
      if (!res.ok) throw "Erro ao cadastrar";
      alert("Empresa cadastrada com sucesso!");
      formCadastroEmpresa.reset();
      carregarEmpresas();
    })
    .catch(err => {
      console.error(err);
      alert("Falha ao cadastrar empresa");
    });
}

/* DESATIVAR EMPRESA */
function abrirModalExcluir(index) {
  excluindoIndex = index;

  const emp = empresasFiltradas[index];
  document.getElementById("nomeEmpresaExcluir").innerText =
    emp.nomeFantasia || emp.razaoSocial;

  document.getElementById("modalExcluir").style.display = "flex";
}

function fecharModalExcluir() {
  document.getElementById("modalExcluir").style.display = "none";
  excluindoIndex = -1;
}

function confirmarExclusao() {
  if (excluindoIndex < 0) return;

  const empresa = empresasFiltradas[excluindoIndex];

  fetch(`/cadastroempresa/desativar/${empresa.tokenEmpresa}`, {
    method: "PUT"
  })
    .then(res => {
      if (!res.ok) throw "Erro ao desativar";

      alert("Empresa desativada!");

      carregarEmpresas();  

      
      if (window.carregarDashboard) {
        carregarDashboard();
      }

      fecharModalExcluir();
    })
    .catch(err => {
      console.error(err);
      alert("Erro ao desativar empresa");
    });
}

function abrirModalEdicao(index) {
  const emp = empresasFiltradas[index];
document.getElementById("modal_tokenEmpresa").value = emp.tokenEmpresa;
  document.getElementById("modalTitle").innerText = "Editar Empresa";

  modal_razaoSocial.value = emp.razaoSocial;
  modal_nomeFantasia.value = emp.nomeFantasia;
  modal_cnpj.value = emp.cnpj;
  modal_cep.value = emp.cep || "";
  modal_logradouro.value = emp.logradouro || "";
  modal_bairro.value = emp.bairro || "";
  modal_cidade.value = emp.cidade || "";
  modal_uf.value = emp.estado || "";
  modal_numero.value = emp.numero || "";

  document.getElementById("formulario").dataset.token = emp.tokenEmpresa;


  document.getElementById("modalBackdrop").style.display = "flex";
}

function salvarEmpresa(event) {
  event.preventDefault();

  const token = document.getElementById("modal_tokenEmpresa").value;

  const dados = {
    razaoSocial: modal_razaoSocial.value,
    nomeFantasia: modal_nomeFantasia.value,
    cnpj: modal_cnpj.value,
    cep: modal_cep.value,
    logradouro: modal_logradouro.value,
    bairro: modal_bairro.value,
    cidade: modal_cidade.value,
    estado: modal_uf.value,
    numero: modal_numero.value
  };

  fetch(`/cadastroempresa/editar/${token}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  })
    .then(res => {
      if (!res.ok) throw "Erro ao atualizar empresa";

      alert("Empresa atualizada com sucesso!");
      fecharModal();
      carregarEmpresas();
    })
    .catch(err => {
      console.error(err);
      alert("Erro ao atualizar empresa");
    });
}


function fecharModal() {
  document.getElementById("modalBackdrop").style.display = "none";
}



/* INICIALIZAÇÃO*/
carregarEmpresas();
mostrarAba("formulario");
</script>

</body>

</html>