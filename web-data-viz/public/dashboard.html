  <!DOCTYPE html>
  <html lang="pt-BR">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="css/estiloDashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="assets/icon/chip.png">
    <script src="./js/sessao.js"></script>
    <!-- <script src="./js/dadosMock.js"></script> -->
    <script src="./js/dados.js"></script>
    <title>Dados - CyberBeef</title>
  </head>

  <body onload="validarSessao()">
    <header class="navbar">
      <button id="but_atualizar_bl" class="clicavel bxr bxs-menu-select clicado"
        onclick="atualizarBarraLateral()"></button>
      <span id="sel_componentes" name="op_setor" class="sel_dash">
        <p>TODAS AS M√ÅQUINAS</p>

        <button id="dash_todas_maquinas" style="display: none;" class="" data-comp="geral"
          data-kpi1="M√°quina(s) monitoradas" data-kpi2="Alerta(s) (√∫ltimos 7 dias)" data-kpi3="Dia(s) sem alertas"
          data-kpi4="M√°quina com mais alertas (√∫ltimos 7 dias)">GERAL</button>

        <button data-comp="geral" class="" data-comp="geral" data-kpi1="Setore(s) monitorados"
          data-kpi2="Alerta(s) (√∫ltimos 7 dias)" data-kpi3="Dia(s) sem alertas"
          data-kpi4="Componente com mais alertas (√∫ltimos 7 dias)">GERAL</button>

        <button data-comp="cpu" data-kpi1="√öltima medi√ß√£o de uso" data-kpi2="Alerta(s) (√∫ltimos 7 dias)"
          data-kpi3="Dia(s) sem alertas" data-kpi4="Coeficiente de varia√ß√£o de uso (√∫ltimos 7 dias)">CPU</button>

        <button data-comp="ram" value="dash_ram" data-kpi1="√öltima medi√ß√£o de uso" data-kpi2="Alerta(s) (√∫ltimos 7 dias)"
          data-kpi3="Dia(s) sem alertas" data-kpi4="Coeficiente de varia√ß√£o de uso (√∫ltimos 7 dias)">RAM</button>

        <button data-comp="disco" data-kpi1="√öltima medi√ß√£o de uso" data-kpi2="Alerta(s) (√∫ltimos 7 dias)"
          data-kpi3="Dia(s) sem alertas" data-kpi4="Coeficiente de varia√ß√£o de uso (√∫ltimos 7 dias)">DISCO</button>

        <button data-comp="rede" data-kpi1="√öltimos dados enviados" data-kpi2="Alerta(s) (√∫ltimos 7 dias)"
          data-kpi3="Dia(s) sem alertas" data-kpi4="Perda de pacotes (√∫ltima captura)">REDE</button>
      </span>
      </div>
      <nav id="buts_superiores">
        <a class="clicavel clicado">Exportar dados <i class='bxr  bx-arrow-down-stroke-circle'></i></a>
        <a class="clicavel clicado">Gerar Relat√≥rio</a>
      </nav>
    </header>

    <div class="barra_lateral sombreado ativa">
      <div id="logo"></div>
      <hr>
      <div id="usuario">
        <i class='bxr  bxs-user' style='color:#fffafa'></i>
        <a id="b_usuario" class="texto_perfil"
          style=" max-width: 100%; overflow: hidden; text-overflow: ellipsis;">User</a>
      </div>
      <hr>
      <div id="home" class="ops_home">
        <ul></ul>
        <li class="clicado"><a href="index.html">Home</a></li>
        <li class="clicado"><a>Pain√©is</a></li>
        <li class="clicado"><a href="dados.html?tipoDados=maquina&titulo=M√°quinas">M√°quinas</a></li>
        <li class="clicado"><a href="alertas.html">Alertas</a></li>
        <li class="clicado"><a href="dados.html?tipoDados=setor&titulo=Setores">Setores</a></li>
        <li class="clicado"><a href="dados.html?tipoDados=user&titulo=Usu√°rios">Usu√°rios</a></li>
        <span onclick="limparSessao()"
          style="display: inline-flex; align-items: center; color: #fffafa; font-size: large; gap: 1%;"
          class="clicavel clicado" title="Clique para sair de sua conta">
          <i class='bxr  bx-arrow-out-left-square-half' style="color: #fffafa;"></i>
          <p>SAIR
          <p>
        </span>
      </div>
    </div>

    <div id="elementos" class="bl_ativa">
      <div class="cards">
        <div id="barra_pesquisa">
          <input type="text" placeholder="Pesquisar por m√°quinas..." id="pesquisa" class="interativo">

          <div id="nomes_dash" class="accordion"></div>
        </div>
        <span class="abas_kpis">
          <button data-aba="1" class="kpi interativo ativa">
            <b id="kpi1" class="dado_card">CARREGANDO...</b>
            <p id="kpi1_desc">Setores Monitorados</p>
            <i id="kpi1_result" class="text_longo" onclick="">[...]</i>
          </button>

          <button data-aba="2" class="kpi interativo">
            <b id="kpi2" class="dado_card">CARREGANDO...</b>
            <p id="kpi2_desc">Alerta(s) (√∫ltimos 7 dias)</p>
            <i id="kpi2_result" class="text_longo" onclick="">[...]</i>
          </button>

          <button data-aba="3" class="kpi interativo">
            <b id="kpi3" class="dado_card">CARREGANDO...</b>
            <p id="kpi3_desc">Dia(s) sem alertas</p>
            <i id="kpi3_result" class="text_longo" id="compKpi3" onclick="">[...]</i>
          </button>

          <button data-aba="4" class="kpi interativo">
            <b id="kpi4" class="dado_card">CARREGANDO...</b>
            <p id="kpi4_desc" class="text_longo">Componente com mais ocorr√™cias</p>
            <i id="kpi4_result" class="text_longo" id="compKpi4" onclick="">[...]</i>
          </button>
        </span>

        <div id="aba_conteudo" class="interativo">
          <p id="titulo-conteudo">Mais Detalhes</p>
          <div id="cardsContainer"></div>
        </div>

      </div>
      <div id="graficos">
        <span class="grafico sombreado interativo"><canvas id="grafico1"></canvas> </span>
        <span class="grafico sombreado interativo"><canvas id="grafico2"></canvas> </span>
      </div>
    </div>

  </body>
  <script>
    // Configura√ß√µes B√°sicas dos Gr√°ficos
    Chart.defaults.color = "rgba(255,255,255,0.8)";
    Chart.defaults.font.family = "Inter, sans-serif";
    Chart.defaults.plugins.tooltip.bodyColor = "#fff";
    Chart.defaults.font.size = 12;

    // Dados Mockados vindo de "./js/dadosMock.js"
    let componente;
    const graficosAtivos = {};

    const botoescomp = document.querySelectorAll("#sel_componentes button");

    const barraLateral = document.querySelector('.barra_lateral');
    const butAtualizarBl = document.getElementById('but_atualizar_bl');

    const elementos = document.getElementById('elementos');

    const popup = document.getElementById('barra_pesquisa');
    const campo = document.getElementById('pesquisa');
    const nomesDash = document.getElementById('nomes_dash');

    const dadosCard = document.querySelectorAll('.dado_card')
    const buttons = document.querySelectorAll('.abas_kpis button');

    const container = document.getElementById("cardsContainer");
    const contents = document.getElementById('aba_conteudo');
    const tituloContent = document.getElementById('titulo-conteudo');

    trazerDadosDash().then(() => {
      let dashAtual = dados[0];
      console.log(JSON.stringify(dados))
      for (let i = 0; i < dados.length; i++) {
        dash = dados[i];
        const nome = document.createElement("div");
        nome.classList.add("item", "clicado");

        nome.innerHTML = `<button id="${i}_dash" class="titulo_dash">${dash.dashboard}</a></button>`;
        nomesDash.appendChild(nome);
      }
      const dashboards = document.querySelectorAll(".titulo_dash");

      dashboards.forEach(dash => {
        dash.addEventListener('click', e => {
          indexDash = (parseInt((dash.id).split("_")[0]))
          dashAtual = dados[indexDash]
          document.querySelectorAll("#sel_componentes p")[0].textContent = dashAtual.dashboard.toUpperCase();
          if (indexDash != 0) {
            botoescomp.forEach(botao => {
              if (botao.id == "dash_todas_maquinas") botao.classList.remove('aparente');
              else botao.classList.add('aparente')
              botoescomp[1].dispatchEvent(new Event("click"));
            })
          }
          else {
            botoescomp.forEach(botao => {
              if (botao.id == "dash_todas_maquinas") botao.classList.add('aparente');
              else botao.classList.remove('aparente')
              botoescomp[0].dispatchEvent(new Event("click"));
            })
          }
          campo.value = dash.textContent;
        })
      });

      botoescomp.forEach(botao => {
        botao.addEventListener("click", () => {
          botoescomp.forEach(b => b.classList.remove("ativo"));
          botao.classList.add("ativo");
          componente = dashAtual.recursos[botao.dataset['comp']];
          montarGrafico(componente["grafico1"])
          montarGrafico(componente["grafico2"])

          for (let i = 0; i < 4; i++) {
            const kpiDado = document.querySelector(`#kpi${i + 1}`)
            const kpiDesc = document.querySelector(`#kpi${i + 1}_desc`);
            const kpiResult = document.querySelector(`#kpi${i + 1}_result`);

            kpiDado.textContent = componente[Object.keys(componente)[i]][0]
            kpiDesc.textContent = botao.dataset[`kpi${i + 1}`];
            const [color, text] = textoComparacao(componente[Object.keys(componente)[i]][1]);
            kpiResult.style.color = color;
            kpiResult.textContent = text;
          }
          buttons[0].dispatchEvent(new Event("click"));
        });
      });

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('ativa'));
          var conteudo = componente[btn.querySelector('b').id][2];
          container.innerHTML = "";

          conteudo.forEach((bloco) => {
            const card = document.createElement("div");

            card.classList.add("card");

            card.innerHTML = `
          <h3>${bloco.titulo}</h3>
          <div class="dados">
            ${bloco.dados
                .map(
                  (d) => `
                <div class="dado-item">
                  <span class="dado-nome">${d.nome}</span>
                  ${colorirDado(d)}
                </div>
              `
                )
                .join("")}
          </div>
          `;
            container.appendChild(card);
          });
          btn.classList.add('ativa');
        });
      });
      // Cliques iniciais
      botoescomp[0].dispatchEvent(new Event("click"));
      buttons[0].dispatchEvent(new Event("click"));
    });

    function atualizarBarraLateral() {
      barraLateral.classList.toggle('ativa');
      elementos.classList.toggle('bl_ativa');
      butAtualizarBl.classList.toggle('bxs-menu-wide');
      butAtualizarBl.classList.toggle('bxs-menu-select');
    }

    function textoComparacao(comparacao) {
      if (isNaN(comparacao)) return ["#FFFF", "Veja maisüîçÔ∏é"]
      else if (comparacao > 0) return ["#E94F37", comparacao.toFixed(1).replaceAll(".", ",") + " A mais que o per√≠odo anterior‚ñ≤"]
      else if (comparacao < 0) return ["#6EEB83", (comparacao * (-1)).toFixed(1).replaceAll(".", ",") + " A menos que o per√≠odo anterior‚ñº"]
      else return ["#FFD447", "N√∫mero igual ao per√≠odo anterior"]
    }

    function montarGrafico({ id, tipo, dados, labels, titulo = "", xylabels = [] }) {
      const ctx = document.getElementById(id).getContext("2d");


      if (graficosAtivos[id]) {
        graficosAtivos[id].destroy();
      }


      const ehHistograma = tipo === "histograma";

      if (ehHistograma) {
        const binSize = 10;
        const bins = gerarBins(dados, binSize);
        labels = bins.map(b => `${Math.trunc(b.x)}-${Math.trunc((b.x + binSize))}`);
        dados = bins.map(b => b.count);
        tipo = "bar";
      }

      graficosAtivos[id] = new Chart(ctx, {
        type: tipo,
        data: {
          labels: labels,
          datasets: [{
            label: titulo || tipo.charAt(0).toUpperCase() + tipo.slice(1),
            data: dados,
            backgroundColor: tipo === "line"
              ? "rgba(75, 108, 240, 0.3)"
              : "rgba(75, 108, 240, 0.6)",
            borderColor: "#4B6CF0",
            borderWidth: 2,
            tension: 0.1,
            fill: tipo === "line",
            ...(ehHistograma && {
              barPercentage: 1.0,
              categoryPercentage: 1.0
            })
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: !!titulo,
              text: titulo
            }
          },
          scales: {
            x: {
              title: { display: true, text: xylabels[0] },
              callback: function (value) {
                const label = this.getLabelForValue(value);
                return isNaN(label) ? label : Math.trunc(Number(label));
              }
            },
            y: {
              title: { display: true, text: xylabels[1] },
              beginAtZero: true,
              grid: {
                display: true,
                color: "rgba(255,255,255, 0.05)"
              },
              ticks: {
                stepSize: 1,
                callback: function (value) {
                  return Number.isInteger(value) ? value : null;
                }
              }
            }
          }
        }
      });
    }

    // Fun√ß√£o auxiliar de gr√°ficos do tipo histograma
    function gerarBins(dados, binSize) {
      const min = 0;
      const max = 100;
      const bins = [];

      const nBins = Math.ceil((max - min) / binSize);

      for (let j = 0; j < nBins; j++) {
        const x = Math.trunc((min + j * binSize));
        bins.push({ x: x, count: 0 });
      }

      dados.forEach(valor => {
        const index = Math.floor((valor - min) / binSize);
        if (bins[index]) bins[index].count++;
      });

      return bins;
    }

    // Exemplo de uso:
    // montarGrafico({ id: "grafico1" , tipo: "bar", dados: [10, 15, 7, 12, 20, 18], labels: labelsExemplo, titulo: "Gr√°fico de Barras", xylabels: ["A", "B"] });
    // montarGrafico({ id: "grafico1", tipo: "line", dados: [2, 4, 6, 8, 12, 14], labels: labelsExemplo, titulo: "Gr√°fico de Linhas", xylabels: ["A", "B"]  });
    // montarGrafico({ id: "grafico1", tipo: "histograma", dados: dadosExemplo, titulo: "Histograma", xylabels: ["A", "B"] });

    // Pesquisa
    campo.addEventListener('input', e => {
      const termo = e.target.value.toLowerCase();
      document.querySelectorAll('.item').forEach(item => {
        const texto = item.querySelector('.titulo_dash').textContent.toLowerCase();
        item.style.display = texto.includes(termo) ? 'block' : 'none';
      });
    });

    //Modificar essa fun√ß√£o no futuro 
    function colorirDado(dado) {
      let color = "#ffff";
      const num = dado.valor;
      if (dado.nome == "Perda de Pacotes") {
        if (num > 5) color = "#E94F37";
        else if (num >= 2.5) color = "#FFD447";
        else color = "#6EEB83";
      }
      if (dado.nome == "Dado") {
        if (num > 90) color = "#E94F37";
        else if (num >= 85) color = "#FFD447";
        else color = "#6EEB83";
        dado.valor = ((dado.valor).toString()).replaceAll(".", ",");
        return `<span class="dado-valor" style="color: ${color};">${dado.valor}%</span>`;
      }
      if (dado.nome == "Upload" || dado.nome == "Download") {
        dado.valor = ((dado.valor).toString()).replaceAll(".", ",");
        return `<span class="dado-valor" style="color: ${color};">${dado.valor}MB/s</span>`;
      }

      return `<span class="dado-valor" style="color: ${color};">${dado.valor}</span>`;
    }
  </script>

  </html>